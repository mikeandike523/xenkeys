{
  "version": 3,
  "sources": ["../../src/worklets/pitch-synth.worklet.ts"],
  "sourcesContent": ["// AudioWorklet: Generalized polyphonic pitch synth (temperament-agnostic).\n// Loads via: audioContext.audioWorklet.addModule('/worklets/pitch-synth.js')\n// Build: esbuild -> public/worklets/pitch-synth.js (ESM)\n//\n// Assumptions:\n// - Client logic computes frequencies (12EDO, 24EDO, N-EDO, just intonation, etc.)\n//   and sends them via postMessage({ type: 'noteOn', data: { id, freq, ... } }).\n// - This processor focuses on envelopes, simple waveforms, and mixing.\n//\n// TS notes:\n// - Include \"DOM\" and \"WebWorker\" libs in tsconfig for AudioWorklet types.\n// - ESM output (no IIFE). See the esbuild command you planned earlier.\n\nimport { type AudioParamDescriptor } from \"./extra-glue-types.d\";\n\nimport {\n  Envelope,\n  PitchSynthMessage,\n  Waveform\n} from \"@shared-types/audio-engine\";\n\ntype VoiceState = 'idle' | 'attack' | 'decay' | 'sustain' | 'release';\n\n// Some environments need this to placate TS about global `sampleRate` in worklets.\ndeclare const sampleRate: number;\n\n// --- Utilities ---------------------------------------------------------------\n\nconst clamp = (x: number, lo: number, hi: number) => Math.max(lo, Math.min(hi, x));\n\nfunction secondsToSamples(sec: number, sr: number): number {\n  // at least 1 sample to avoid division-by-zero edge cases\n  return Math.max(1, Math.floor(Math.max(0, sec) * sr));\n}\n\n/**\n * Generalized power-sine oscillator: |sin(2\u03C0\u00B7phase)|^n * sign(sin(2\u03C0\u00B7phase)).\n */\nfunction powerSin(phase: number, n: number): number {\n  const s = Math.sin(2 * Math.PI * phase);\n  return Math.pow(Math.abs(s), n) * Math.sign(s);\n}\n\n// --- Voice -------------------------------------------------------------------\n\nclass PolyVoice {\n  private sr: number;\n  private _freq = 440;\n  private _samples = 0;\n\n  private _state: VoiceState = 'idle';\n\n  private envSamples = 0;       // samples within current stage\n  private attackSamples = 0;\n  private decaySamples = 0;\n  private releaseSamples = 0;\n  private sustainLevel = 0;\n\n  public noteId = 0;\n  public waveform: Waveform = 'sine';\n\n  constructor(sr: number) {\n    this.sr = sr;\n  }\n\n  public get state(): VoiceState {\n    return this._state;\n  }\n\n  noteOn(freq: number, id: number, env: Envelope): void {\n    this._freq = freq;\n    this.noteId = id;\n    this._state = 'attack';\n    this.envSamples = 0;\n    this._samples = 0;\n\n    this.attackSamples = secondsToSamples(env.attack, this.sr);\n    this.decaySamples = secondsToSamples(env.decay, this.sr);\n    this.releaseSamples = secondsToSamples(env.release, this.sr);\n    this.sustainLevel = clamp(env.sustain, 0, 1);\n  }\n\n  noteOff(id: number): void {\n    if (this._state !== 'idle' && this.noteId === id && this._state !== 'release') {\n      this._state = 'release';\n      this.envSamples = 0;\n    }\n  }\n\n  forceRelease(): void {\n    if (this._state !== 'idle') {\n      this._state = 'release';\n      this.envSamples = 0;\n    }\n  }\n\n  setWaveform(w: Waveform): void {\n    this.waveform = w;\n  }\n\n  process(): number {\n    // Envelope\n    let envAmp = 0;\n\n    switch (this._state) {\n      case 'attack': {\n        envAmp = this.envSamples / this.attackSamples;\n        if (this.envSamples++ >= this.attackSamples) {\n          this._state = 'decay';\n          this.envSamples = 0;\n        }\n        break;\n      }\n      case 'decay': {\n        const t = this.envSamples / this.decaySamples;\n        envAmp = 1 + (this.sustainLevel - 1) * t; // linear decay\n        if (this.envSamples++ >= this.decaySamples) {\n          this._state = 'sustain';\n          this.envSamples = 0;\n        }\n        break;\n      }\n      case 'sustain': {\n        envAmp = this.sustainLevel;\n        break;\n      }\n      case 'release': {\n        const t = this.envSamples / this.releaseSamples;\n        envAmp = this.sustainLevel * (1 - t);\n        if (this.envSamples++ >= this.releaseSamples) {\n          this._state = 'idle';\n          this.envSamples = 0;\n          this.noteId = 0;\n          return 0;\n        }\n        break;\n      }\n      default:\n        return 0;\n    }\n\n    // Phase & waveform\n    const t = (this._samples * this._freq) / this.sr;\n    const phase = t - Math.floor(t); // [0,1)\n    let sample: number;\n\n    switch (this.waveform) {\n      case 'square':\n        sample = phase < 0.5 ? 1 : -1;\n        break;\n      case 'triangle':\n        sample = 1 - 4 * Math.abs(phase - 0.5);\n        break;\n      case 'sawtooth':\n        sample = 2 * phase - 1;\n        break;\n      case 'power2':\n        sample = powerSin(phase, 2);\n        break;\n      case 'power3':\n        sample = powerSin(phase, 3);\n        break;\n      case 'power4':\n        sample = powerSin(phase, 4);\n        break;\n      case 'selfmod0.1':\n        sample = Math.sin(\n          2 * Math.PI * phase + 0.1 * 2 * Math.PI * Math.sin(2 * Math.PI * phase)\n        );\n        break;\n      case 'selfmod0.2':\n        sample = Math.sin(\n          2 * Math.PI * phase + 0.2 * 2 * Math.PI * Math.sin(2 * Math.PI * phase)\n        );\n        break;\n      case 'selfmod0.3':\n        sample = Math.sin(\n          2 * Math.PI * phase + 0.3 * 2 * Math.PI * Math.sin(2 * Math.PI * phase)\n        );\n        break;\n      case 'sine':\n      default:\n        sample = Math.sin(2 * Math.PI * phase);\n        break;\n    }\n\n    this._samples++;\n    return sample * envAmp;\n  }\n}\n\n// --- Processor ---------------------------------------------------------------\n\ntype ParameterMap = {\n  volume: Float32Array;\n};\n\nconst DEFAULT_ENV: Envelope = {\n  attack: 0.01,\n  decay: 0.1,\n  sustain: 0.7,\n  release: 0.5,\n};\n\nclass PitchSynthProcessor extends AudioWorkletProcessor {\n  static get parameterDescriptors(): AudioParamDescriptor[] {\n    return [\n      { name: 'volume', defaultValue: 0.8, minValue: 0, maxValue: 1, automationRate: 'a-rate' },\n    ];\n  }\n\n  private voices: PolyVoice[] = [];\n  private baseEnvelope: Envelope = { ...DEFAULT_ENV };\n  private waveform: Waveform = 'sine';\n\n  constructor() {\n    super();\n\n    // Default polyphony: 16\n    this.resizeVoices(16);\n\n    this.port.onmessage = (e: MessageEvent<PitchSynthMessage>) => {\n      const msg = e.data;\n      switch (msg.type) {\n        case 'noteOn': {\n          const env: Envelope = {\n            attack: msg.data.envelope?.attack ?? this.baseEnvelope.attack,\n            decay: msg.data.envelope?.decay ?? this.baseEnvelope.decay,\n            sustain: msg.data.envelope?.sustain ?? this.baseEnvelope.sustain,\n            release: msg.data.envelope?.release ?? this.baseEnvelope.release,\n          };\n          const v = this.findFreeOrSteal();\n          v.setWaveform(this.waveform);\n          v.noteOn(msg.data.freq, msg.data.id, env);\n          break;\n        }\n        case 'noteOff': {\n          const { id } = msg.data;\n          this.voices.forEach((v) => v.noteOff(id));\n          break;\n        }\n        case 'waveform': {\n          this.waveform = msg.data;\n          // Apply immediately to ringing voices\n          this.voices.forEach((v) => v.setWaveform(this.waveform));\n          break;\n        }\n        case 'setEnvelope': {\n          this.baseEnvelope = {\n            attack: msg.data.attack ?? this.baseEnvelope.attack,\n            decay: msg.data.decay ?? this.baseEnvelope.decay,\n            sustain: msg.data.sustain ?? this.baseEnvelope.sustain,\n            release: msg.data.release ?? this.baseEnvelope.release,\n          };\n          break;\n        }\n        case 'allNotesOff': {\n          this.voices.forEach((v) => v.forceRelease());\n          break;\n        }\n        case 'setPolyphony': {\n          const n = Math.max(1, Math.floor(msg.data.voices));\n          this.resizeVoices(n);\n          break;\n        }\n      }\n    };\n  }\n\n  private resizeVoices(n: number): void {\n    if (n === this.voices.length) return;\n    if (n > this.voices.length) {\n      const add = n - this.voices.length;\n      for (let i = 0; i < add; i++) this.voices.push(new PolyVoice(sampleRate));\n    } else {\n      // Shrink: release extra voices first to avoid clicks\n      for (let i = n; i < this.voices.length; i++) this.voices[i].forceRelease();\n      this.voices.length = n;\n    }\n    // Ensure current waveform applies to all\n    this.voices.forEach((v) => v.setWaveform(this.waveform));\n  }\n\n  private findFreeOrSteal(): PolyVoice {\n    const free = this.voices.find((v) => v.state === 'idle');\n    if (free) return free;\n    // Simple voice stealing: reuse voice 0\n    return this.voices[0];\n  }\n\n  process(\n    _inputs: Float32Array[][],\n    outputs: Float32Array[][],\n    parameters: ParameterMap\n  ): boolean {\n    const output = outputs[0];\n    if (!output || output.length === 0) return true;\n\n    const frameCount = output[0].length;\n\n    // Ensure all channels same length\n    for (let ch = 1; ch < output.length; ch++) {\n      if (output[ch].length !== frameCount) {\n        throw new Error('All outputs must have the same length');\n      }\n    }\n\n    const vol = parameters.volume;\n    for (let i = 0; i < frameCount; i++) {\n      let mix = 0;\n      for (let v = 0; v < this.voices.length; v++) {\n        mix += this.voices[v].process();\n      }\n      const gain = vol.length > 1 ? vol[i] : vol[0];\n      const s = mix * gain * 0.25; // headroom\n\n      for (let ch = 0; ch < output.length; ch++) {\n        output[ch][i] = s;\n      }\n    }\n\n    return true;\n  }\n}\n\n// The name is generalized (no \u201Cquarter-tone\u201D baked in).\nregisterProcessor('pitch-synth', PitchSynthProcessor);\n"],
  "mappings": "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",
  "names": ["clamp", "x", "lo", "hi", "secondsToSamples", "sec", "sr", "powerSin", "phase", "n", "PolyVoice", "__publicField", "freq", "id", "env", "w", "envAmp", "t", "sample", "DEFAULT_ENV", "PitchSynthProcessor", "e", "msg", "v", "add", "i", "free", "_inputs", "outputs", "parameters", "output", "frameCount", "ch", "vol", "mix", "gain", "s"]
}
